<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>全米ETF VTI(S&P500)、VT(オルカン)自動計算機</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
                background-color: #f0f4f8;
                color: #333;
            }
            .container {
                max-width: 400px;
                padding: 25px;
                border-radius: 15px;
                background: white;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                margin: auto;
            }
            h3 {
                margin-top: 0;
                text-align: center;
                color: #1a365d;
                border-bottom: 2px solid #e2e8f0;
                padding-bottom: 10px;
                font-size: 18px;
            }
            .stock-box {
                background: #f8fafc;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
            }
            .stock-title {
                font-weight: bold;
                font-size: 18px;
                margin-bottom: 10px;
                color: #2d3748;
                display: flex;
                justify-content: space-between;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-size: 13px;
                color: #718096;
            }
            input {
                width: 100%;
                margin-bottom: 8px;
                padding: 10px;
                box-sizing: border-box;
                border: 1px solid #cbd5e0;
                border-radius: 6px;
                font-size: 16px;
            }
            input[readonly] {
                background-color: #edf2f7;
                color: #4a5568;
            }
            .subtotal-area {
                text-align: right;
                font-weight: bold;
                color: #2d3748;
                font-size: 15px;
                padding-top: 5px;
                border-top: 1px dashed #cbd5e0;
            }
            .price-info {
                font-size: 11px;
                color: #a0aec0;
                margin: 5px 0 0 0;
                text-align: right;
            }

            /* 合計エリアの調整 */
            .result-area {
                background: #1a365d;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                color: white;
                margin-top: 20px;
            }
            .result-label {
                font-size: 14px;
                opacity: 0.8;
                margin-bottom: 8px;
            }
            .result-row {
                display: flex;
                justify-content: center;
                align-items: baseline;
                margin-bottom: 5px;
            }
            .result-value {
                font-weight: bold;
                font-size: 28px;
                color: #63b3ed;
            }
            .result-value.jpy {
                color: #fbd38d;
                font-size: 24px;
            } /* 円表示は少し色とサイズを変える */
            .unit {
                margin-left: 5px;
                font-size: 14px;
                opacity: 0.9;
            }

            .rate-info {
                font-size: 11px;
                color: #cbd5e0;
                margin-top: 10px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                padding-top: 8px;
            }
            .nav-link {
                display: block;
                text-align: center;
                margin-top: 20px;
                font-size: 14px;
                color: #3182ce;
                text-decoration: none;
            }
        </style>
    </head>
    <body>
        <nav id="site-nav">
            <style>
                #site-nav {
                    text-align: center;
                    padding: 15px 0;
                    margin-bottom: 20px;
                }
                .nav-link {
                    display: inline-block;
                    margin: 0 5px;
                    padding: 10px 18px;
                    background: rgba(255, 255, 255, 0.7);
                    text-decoration: none;
                    color: #555;
                    border-radius: 25px;
                    font-size: 0.85rem;
                    font-weight: bold;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                    transition: all 0.3s ease;
                    border: 1px solid transparent;
                }
                .nav-link:hover {
                    transform: translateY(-2px);
                    background: #fff;
                    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
                }
                /* 今いるページのボタンを自動で目立たせるスタイル */
                .nav-link.active {
                    background: #007bff;
                    color: white;
                    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
                }
            </style>

            <a href="index.html" class="nav-link">メイン計算機</a>
            <a href="chasepankun.html" class="nav-link">パンくんを追え</a>
            <a href="index1.html" class="nav-link">Ver.1</a>
            <a href="index2.html" class="nav-link">Ver.2</a>

            <script>
                // 今見ているURLをチェックして、一致するリンクに "active" クラスをつける魔法
                const currentFile =
                    window.location.pathname.split('/').pop() || 'index.html';
                const links = document.querySelectorAll('.nav-link');
                links.forEach((link) => {
                    if (link.getAttribute('href') === currentFile) {
                        link.classList.add('active');
                    }
                });
            </script>
        </nav>
        <div class="container">
            <h3>全米ETF VTI(S&P500)、VT(オルカン)自動計算機 V.20260129</h3>

            <div class="stock-box">
                <div class="stock-title">
                    <span>VTI</span
                    ><span
                        id="vti-price-display"
                        style="font-size: 14px; color: #4a5568"
                        >取得中...</span
                    >
                </div>
                <label>現在価格 (USD)</label>
                <input type="number" id="vti-price" readonly step="0.01" />
                <label>保有株数</label>
                <input
                    type="number"
                    id="vti-qty"
                    value="0"
                    min="0"
                    oninput="calculate()"
                />
                <div class="subtotal-area">
                    小計: <span id="vti-subtotal">0.00</span> USD
                </div>
                <p id="vti-update" class="price-info">読込中...</p>
            </div>

            <div class="stock-box">
                <div class="stock-title">
                    <span>VT</span
                    ><span
                        id="vt-price-display"
                        style="font-size: 14px; color: #4a5568"
                        >取得中...</span
                    >
                </div>
                <label>現在価格 (USD)</label>
                <input type="number" id="vt-price" readonly step="0.01" />
                <label>保有株数</label>
                <input
                    type="number"
                    id="vt-qty"
                    value="0"
                    min="0"
                    oninput="calculate()"
                />
                <div class="subtotal-area">
                    小計: <span id="vt-subtotal">0.00</span> USD
                </div>
                <p id="vt-update" class="price-info">読込中...</p>
            </div>

            <div class="result-area">
                <div class="result-label">総合計評価額</div>
                <div class="result-row">
                    <span id="total-val" class="result-value">0.00</span
                    ><span class="unit">USD</span>
                </div>
                <div class="result-row">
                    <span id="total-jpy" class="result-value jpy">0</span
                    ><span class="unit">JPY</span>
                </div>
                <div id="rate-display" class="rate-info">
                    為替レート取得中...
                </div>
            </div>

            <a href="index.html" class="nav-link">← 単純計算機に戻る</a>
        </div>
        <script>
            // 外部APIを叩く際のCORS制限（セキュリティ制限）を回避するためのプロキシサーバーのURL
            // const proxy = 'https://corsproxy.io/?';
            // const proxy = 'https://api.allorigins.win/raw?url='; // これを消して以下に変更
            const proxy = 'https://y-cors.vercel.app/api?url=';
            // 米ドル/円の為替レートを保持するための変数（初期値は0）
            let usdJpyRate = 0;

            // 特定の銘柄（VTIやVT）の価格を取得する非同期関数
            async function fetchPrice(symbol, priceId, updateId, displayId) {
                // Yahoo FinanceのチャートAPIからデータを取得するためのURL（シンボル名を埋め込む）
                const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                try {
                    // プロキシを経由してAPIにリクエストを送り、レスポンスを待機(await)
                    const response = await fetch(
                        proxy + encodeURIComponent(targetUrl),
                    );
                    // レスポンスのJSONデータを解析
                    const data = await response.json();
                    // JSONの階層を辿って現在の市場価格（株価）を抽出
                    const currentPrice =
                        data.chart.result[0].meta.regularMarketPrice;

                    // 隠し入力欄（または数値保持用）に最新価格を設定
                    document.getElementById(priceId).value = currentPrice;
                    // 表示用の要素に、ドル記号を付けて小数点2桁で表示
                    document.getElementById(displayId).innerText =
                        `$${currentPrice.toFixed(2)}`;
                    // 取得に成功した時間を画面に表示
                    document.getElementById(updateId).innerText =
                        `最終取得: ${new Date().toLocaleTimeString()}`;
                    // 価格が更新されたので、合計金額を再計算する関数を呼ぶ
                    calculate();
                } catch (error) {
                    // 通信エラー等が発生した場合の処理
                    document.getElementById(updateId).innerText =
                        '自動取得失敗。手動入力してください。';
                    // 取得に失敗したら、ユーザーが手動で価格を入力できるよう読み取り専用を解除
                    document.getElementById(priceId).readOnly = false;
                }
            }

            // 米ドル/円の為替レートを取得する非同期関数
            async function fetchExRate() {
                // Yahoo Financeの為替取得用URL（JPY=Xは米ドル/円を指す）
                const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/JPY=X`;
                try {
                    const response = await fetch(
                        proxy + encodeURIComponent(targetUrl),
                    );
                    const data = await response.json();
                    // 取得した最新のレートを変数 usdJpyRate に格納
                    usdJpyRate = data.chart.result[0].meta.regularMarketPrice;
                    // 画面上に現在のレートを表示
                    document.getElementById('rate-display').innerText =
                        `現在レート: 1ドル = ${usdJpyRate.toFixed(2)}円`;
                    // レートが更新されたので合計金額を再計算
                    calculate();
                } catch (error) {
                    // エラー時のメッセージ表示
                    document.getElementById('rate-display').innerText =
                        '為替レートの取得に失敗しました';
                }
            }

            // 保有数と価格から合計（ドル・円）を算出する関数
            function calculate() {
                // VTIの価格を取得（空なら0にする）
                const vtiPrice =
                    parseFloat(document.getElementById('vti-price').value) || 0;
                // VTIの保有数を取得（空なら0にする）
                const vtiQty =
                    parseFloat(document.getElementById('vti-qty').value) || 0;
                // VTの価格を取得
                const vtPrice =
                    parseFloat(document.getElementById('vt-price').value) || 0;
                // VTの保有数を取得
                const vtQty =
                    parseFloat(document.getElementById('vt-qty').value) || 0;

                // 各銘柄の小計（価格 × 数量）を計算
                const vtiSub = vtiPrice * vtiQty;
                const vtSub = vtPrice * vtQty;

                // VTIの小計を3桁区切り・小数点2桁で画面に表示
                document.getElementById('vti-subtotal').innerText =
                    vtiSub.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                    });
                // VTの小計を3桁区切り・小数点2桁で画面に表示
                document.getElementById('vt-subtotal').innerText =
                    vtSub.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                    });

                // 2つの銘柄を足してドルベースの合計を算出
                const totalUsd = vtiSub + vtSub;
                // ドル合計を画面に表示
                document.getElementById('total-val').innerText =
                    totalUsd.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                    });

                // 日本円への換算計算（為替レートが0より大きい場合のみ実行）
                if (usdJpyRate > 0) {
                    // ドル合計にレートを掛けて四捨五入（円は整数が一般的）
                    const totalJpy = Math.round(totalUsd * usdJpyRate);
                    // 円合計を3桁区切りで画面に表示
                    document.getElementById('total-jpy').innerText =
                        totalJpy.toLocaleString();
                }
            }

            // ページを読み込んだ瞬間に1回、各データを取得しに行く
            fetchPrice('VTI', 'vti-price', 'vti-update', 'vti-price-display');
            fetchPrice('VT', 'vt-price', 'vt-update', 'vt-price-display');
            fetchExRate();

            // 定期実行の設定：300,000ミリ秒（5分）ごとに最新データへ更新する
            setInterval(() => {
                fetchPrice(
                    'VTI',
                    'vti-price',
                    'vti-update',
                    'vti-price-display',
                );
                fetchPrice('VT', 'vt-price', 'vt-update', 'vt-price-display');
                fetchExRate();
            }, 300000);
        </script>
    </body>
</html>
